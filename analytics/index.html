<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>RozenMD - analytics</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/agency.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Kaushan+Script' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
 <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
 <script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
 <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
<script src="js/jquery.js" type="text/javascript"></script>
<script src="js/d3.js" charset="utf-8"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<link rel="stylesheet" type="text/css" href="css/dc.css" media="screen" /> 
    <link rel="stylesheet" href="css/screen.css" />

<!-- <script src="http://leafletjs.com/dist/leaflet.js"></script> -->
<script src="js/leaflet-pip.min.js"></script>
<link rel="stylesheet" href="css/MarkerCluster.css" />
<link rel="stylesheet" href="css/MarkerCluster.Default.css" />
<script src="js/leaflet.markercluster-src.js"></script>
<!-- <script type="text/javascript" src="map.js"></script> -->
<!-- <script type="text/javascript" src="DataSetAStrippedA.js"></script>
<script type="text/javascript" src="DataSetAStrippedB.js"></script> -->
<link href="css/bootstrap.min.css" rel="stylesheet">

</head>

<body id="page-top" class="index">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="#page-top">RozenMD - analytics</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                   <!--  <li>
                        <a class="page-scroll" href="#services">Services</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#portfolio">Portfolio</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#about">About</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#team">Team</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#contact">Contact</a>
                    </li> -->
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="intro-text">
                <div class="intro-lead-in">Welcome!</div>
                <!-- <div class="intro-heading"></div> -->
                <a href="#mapping" class="page-scroll btn btn-xl">Show Me More</a>
            </div>
        </div>
    </header>

    <!-- Services Section -->
    <section id="services" style="padding:20px;">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">Analytics</h2>
                    <h3 class="section-subheading text-muted">Crossfiltered data from Vicroads incidents</h3>
                </div>
            </div>
            <div class="row text-center">
                <div style="width:33%;float:left">
<div id="chart-ring-year" style="float:none;" >
                 <strong style="text-align:center;">Years</strong>
        <a class="reset" href="javascript:yearRingChart.filterAll();CloselineChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

        <div class="clearfix"></div>
    </div>
                </div>
                <div style="width:33%;float:left">
<div id="quarter-chart" style="float:none;" >
        <strong>Quarters</strong>
        <a class="reset" href="javascript:quarterChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

        <div class="clearfix"></div>
    </div>
                </div>
                <div style="width:33%;float:left">
<div id="severity-chart" style="float:none;" >
        <strong>Severity - 1 = Death, 2 = Major, 3 = No Injury</strong>
        <a class="reset" href="javascript:severityChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

        <div class="clearfix"></div>
    </div>

                </div>



    <div id="chart-line-accidentsperday" style="float:none;"></div>
<!-- <div id="progress">
    <div id="progress-bar"></div>
</div>
    <div id="map"></div>
 -->



<!--     <div id="chart-line-accidentsperhour"></div>
 -->
    <div class="row" style="margin-left:0px;margin-right:0px;text-align:center;">
      <div id="data-count" class="dc-data-count dc-chart">
            <span class="filter-count"></span> selected out of <span class="total-count"></span> records
        </div>
        <table class="table table-bordered table-hover dc-data-table dc-chart">
                <thead>
                <tr class="header">
                    <th>Date</th>
                    <th>Time</th>
                    <th>Severity</th>
              
                </tr>
                </thead>
        </table>

        
    </div>

    
    <script type="text/javascript" src="js/colorbrewer.js"></script>

         
            </div>
        </div>
    </section>
<section id="mapping" style="padding:20px;">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">Mapping</h2>
                    <h3 class="section-subheading text-muted" style="margin-bottom:15px;">Clustered Map of Vicroads incidents</h3>
<h3 style="margin-bottom:0px;" class="section-subheading text-muted" id="progress-text">Please wait a moment as the map populates. </h3    >
                    <p></p>
                </div>
            </div>
            <div class="row text-center">
              
               
                


<div id="progress">
    <div id="progress-bar"></div>
</div>
    <div id="map"></div>




         
            </div>
        </div>
    </section>
    
   

    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <span class="copyright">Built by &copy; Max Rozen 2015 </span>
                </div>
                <div class="col-md-4">
                    <ul class="list-inline social-buttons">
                        <li><a href="https://twitter.com/mxrozen"><i class="fa fa-twitter"></i></a>
                        </li>
                        <li><a href="https://www.facebook.com/M.D.Rozen"><i class="fa fa-facebook"></i></a>
                        </li>
                        <li><a href="https://www.linkedin.com/in/rozenmd"><i class="fa fa-linkedin"></i></a>
                        </li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <ul class="list-inline quicklinks">
                        <li><a href="#">Privacy Policy</a>
                        </li>
                        <li><a href="#">Terms of Use</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
    <script src="js/classie.js"></script>
    <script src="js/cbpAnimatedHeader.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="js/jqBootstrapValidation.js"></script>
    <script src="js/contact_me.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="js/agency.js"></script>
    
<script>
var progressText = document.getElementById('progress-text');
progressText.style.display = 'block';
var quarterChart = dc.pieChart('#quarter-chart');
var yearRingChart = dc.pieChart("#chart-ring-year");
var severityChart = dc.pieChart("#severity-chart");
var accLineChart = dc.lineChart("#chart-line-accidentsperday");
// var hourLineChart = dc.lineChart("#chart-line-accidentsperhour");

d3.csv("DataSetA.csv", function(data) {

    var dateFormat = d3.time.format("%d/%m/%Y").parse;
    var hourFormat = d3.time.format("%H:%M").parse;

    data.forEach(function(d) { 
        d.oldDate = d.ACCIDENT_DATE;
        d.dd = dateFormat(d.ACCIDENT_DATE);
        d.date = dateFormat(d.ACCIDENT_DATE);
        d.Time = hourFormat(d.ACCIDENT_TIME);
        d.Year=d.dd.getFullYear();
        d.cars = +d.NO_OF_VEHICLES;

        var month = d.dd.getMonth();
            if (month <= 2) {
                d.Quarter = 'Q1';
            } else if (month > 2 && month <= 5) {
                d.Quarter =  'Q2';
            } else if (month > 5 && month <= 8) {
                d.Quarter =  'Q3';
            } else {
                d.Quarter =  'Q4';
            }

    });

    var ndx = crossfilter(data);
    var all = ndx.groupAll();
    var dateDim = ndx.dimension(function(d) {return d.date;});
    var hourDim = ndx.dimension(function(d) {return d.Time;});
    var minDate = dateDim.bottom(1)[0].date;
    var maxDate = dateDim.top(1)[0].date;
    var minHour = hourDim.bottom(1)[0];
    var maxHour = hourDim.top(1)[0];
    var carsDmged = dateDim.group().reduceSum(function(d) { return d.cars;});
    var carsDmgedHour = hourDim.group().reduceSum(function(d) { return d.cars;});
    var yearDim  = ndx.dimension(function(d) {return +d.Year;});
    var year_total = yearDim.group().reduceSum(function(d) {return d.cars;});
    var quarter = ndx.dimension(function (d) {return d.Quarter;});
    var quarterGroup = quarter.group().reduceSum(function (d) {return d.cars;});
    var severity = ndx.dimension(function (d) {return d.SEVERITY;});
    var severityGroup = severity.group().reduceSum(function (d) {return d.cars;});
accLineChart
    .width(1000).height(300)
    .elasticY(true)
    .dimension(dateDim)
    .group(carsDmged,"Damaged Cars")
    .renderArea(true)
    .x(d3.time.scale().domain([minDate,maxDate]))
    .brushOn(false)
    .legend(dc.legend().x(50).y(10).itemHeight(13).gap(5))
    .xAxisLabel("Cars damaged per day");
// hourLineChart
//     .width(1000).height(300)
//     .elasticY(true)
//     .dimension(hourDim)
//     .group(carsDmgedHour,"Damaged Cars")
//     .renderArea(true)
//     .x(d3.time.scale().domain([minHour,maxHour]))
//     .brushOn(false)
//     .legend(dc.legend().x(50).y(10).itemHeight(13).gap(5))
//     .xAxisLabel("Cars damaged per hour of the day");

yearRingChart
    .width(180).height(180)
    .dimension(yearDim)
    .radius(80)
    .group(year_total)
    .innerRadius(30);

quarterChart
        .width(180)
        .height(180)
        .radius(80)
        .innerRadius(30)
        .dimension(quarter)
        .group(quarterGroup);

severityChart
    .width(180).height(180)
    .dimension(severity)
    .radius(80)
    .group(severityGroup)
    .innerRadius(30);

dc.dataTable(".dc-data-table")
        .dimension(dateDim)
        .group(function(d) {
            return d.dd.getFullYear() + "/" + (d.dd.getMonth() + 1);
        })
        .size(10)
        .columns([
            function(d) { return d.oldDate; },
            function(d) { return d.ACCIDENT_TIME; },
            function(d) { return d.SEVERITY; },
            // function(d) { return d3.round(d.Close,2); },
            // function(d) { return d3.round(d.Return*100,2) + "%"; },
            // function(d) { return d.Quarter; }
        ])
        .sortBy(function (d) {
            return d.dd;
        })
        .order(d3.ascending)

        .renderlet(function (table) {
            table.selectAll(".dc-table-group").classed("info", true);
        });

    dc.dataCount("#data-count")
        .dimension(ndx) // set dimension to all data
        .group(all); // set group to ndx.groupAll()
    dc.renderAll();
});
</script>

<script type="text/javascript">
    var mapboxAccessToken = 'pk.eyJ1Ijoicm96ZW5tZCIsImEiOiJlODZmMjk3NDBmYTBhODc5M2U0NDBiYzUyMWM3YjlmOSJ9.muc0sJgn7kvqjzT25Sch-A';
    var tiles = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=' + mapboxAccessToken, {
         id: 'mapbox.streets',
         attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="http://mapbox.com">Mapbox</a>'
    }),
    latlng = L.latLng(-37.226, 144.58);

        var map = L.map('map', { center: latlng, zoom: 6, layers: [tiles] });

        var progress = document.getElementById('progress');
        var progressBar = document.getElementById('progress-bar');
        
        function updateProgressBar(processed, total, elapsed, layersArray) {
            if (elapsed > 1000) {
                // if it takes more than a second to load, display the progress bar:
                progress.style.display = 'block';
                progressBar.style.width = Math.round(processed/total*100) + '%';
            }

            if (processed === total) {
                // all markers processed - hide the progress bar:
                progress.style.display = 'none';
                progressText.style.display = 'none';


            }
        }
</script>
<script src="DataSetAFull.js"></script>
<script>
        var markers = L.markerClusterGroup({ chunkedLoading: true, chunkProgress: updateProgressBar });

        var markerList = [];
        var geoJsonLayer = L.geoJson(fullDataSet, {
            onEachFeature: function (feature, layer) {
                //layer.bindPopup(feature.properties.ACCIDENT_NO);
                layer.bindPopup('<b>' + feature.properties.ACCIDENT_DATE + ' - '
                    + feature.properties.ACCIDENT_TIME +'</b><br>'
                            + feature.properties.ACCIDENT_DESCRIPTION + '<br>' 
                            + 'Severity: ' + feature.properties.SEVERITY + '<br>'
                + 'Deaths/People Involved: '
                + feature.properties.NO_PERSONS_KILLED 
                + '/'
                + feature.properties.NO_PERSONS_INVOLVED)
                            ;
            }
        });
        markers.addLayer(geoJsonLayer);
        markers.addLayers(markerList);
        map.addLayer(markers);
    </script>
</body>

</html>
